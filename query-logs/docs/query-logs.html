<!DOCTYPE html>

<html>
<head>
  <title>query-logs.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>query-logs.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="comment">#!/usr/bin/env coffee</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h2>Prereqs for <code>npm install</code></h2>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>fs = require <span class="string">'fs'</span>
bwriter = require <span class="string">'buffered-writer'</span>
breader = require <span class="string">'buffered-reader'</span>
DataReader = breader.DataReader</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h2>Regexes</h2>

            </div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Match a query&#39;s subject, verb, and optional object words
Queries can be one of </p>
<ul>
<li>Subject Verb</li>
<li>Subject Verb Object</li>
</ul>
<p>Queries can be separated by either a comma (which means mulitple queries) or the word, &#39;or&#39; (which means a &#39;multi-select&#39; query).
There can also be multiple multiselect queries.</p>
<p>Query formats:</p>
<ul>
<li>Q = at least one of ( S,V ) or ( S,V,O )</li>
<li>MQ = Q1 or Q2</li>
<li>Q , Q</li>
<li>Q or Q</li>
<li>MQ , Q</li>
<li>Q or MQ</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>qr_subj_verb = <span class="regexp">/^\s*([^,]+)\s+(is\s+excluded)\s*$/</span>
qr_subj_verb_obj = <span class="regexp">/^\s*([^,]+)\s+(equals|contains|is|blast)\s+([^,]+)\s*$/</span>
qr_or_delimiter = <span class="regexp">/\s+or\s+/</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <h2>finial</h2>

            </div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>holds the parsing results. keys of finial are in the format:</p>
<ul>
<li>subject \t count</li>
<li>verb \t count</li>
<li>object \t count</li>
<li>has_multiselect \t count</li>
<li>multiselect_subject \t count</li>
<li>multiselect_verb \t count</li>
<li>multiselect_object \t count</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>finial = {}</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <h2>getQueryField(data)</h2>

            </div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Argument <code>data</code> is assumed to be a line of text of &#39;|&#39; separated values (or columns)
What we want is the 7th column, but values of the columns can contain the | char.
By using a later column that&#39;s guaranteed to have a &#39;yes&#39; or &#39;no&#39; value, we can mostly
work around the problem of <code>split/[|]/</code> splitting text into too many columns</p>
<p>input</p>
<ul>
<li>data = unparsed line from file</li>
</ul>
<p>output</p>
<p>returns String of query column</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">getQueryField</span></span> = (data) -&gt;
	<span class="keyword">return</span> <span class="keyword">unless</span> data
	<span class="keyword">return</span> <span class="keyword">if</span> data.indexOf(<span class="string">'#'</span>) <span class="keyword">is</span> <span class="number">0</span>
	[f0,f1,f2,f3,f4,f5,f6...] = data.split <span class="regexp">/[|]/</span>
	query = f6.join <span class="string">''</span></pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Deal with query having | char in it, ie entire field isn&#39;t quoted if it contains the delimiter character</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	yes_no_idx = <span class="number">0</span>
	<span class="keyword">for</span> f <span class="keyword">in</span> f6
		<span class="keyword">break</span> <span class="keyword">if</span> <span class="regexp">/^\s*(?:yes|no)\s*$/</span>.test f
		yes_no_idx++

	query = (f6[i] <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0.</span>.(yes_no_idx-<span class="number">2</span>)]).join <span class="string">'|'</span> <span class="keyword">unless</span> yes_no_idx <span class="keyword">is</span> <span class="number">0</span>
	<span class="keyword">return</span> <span class="keyword">if</span> <span class="regexp">/^\s*$/</span>.test query
	query = query.replace <span class="regexp">/^\s+/</span>,<span class="string">''</span>
	query.replace <span class="regexp">/\s+$/</span>,<span class="string">''</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <h2>logQuery(fh,data)</h2>

            </div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>input</p>
<ul>
<li>fh = open file handle to log file</li>
<li>data = text to log</li>
</ul>
<p>output</p>
<p>returns undefined</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">logQuery</span></span> = (fh,data) -&gt;
	<span class="keyword">return</span> <span class="keyword">unless</span> data
	fh.write data
	fh.write <span class="string">"\n"</span> <span class="keyword">unless</span> <span class="regexp">/\n$/</span>.test data</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <h2>parseQuery(data)</h2>

            </div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <ul>
<li>query = Original query text, unparsed</li>
<li>matches = Array of N many queries where a query can be:</li>
<li>[Subject,Verb] </li>
<li>[Subject,Verb,Object] </li>
<li>[ [Subject,Verb], [Subject,Verb,Object], ... ] (this is a multiselect query)</li>
<li>has_multiselect = Boolean, true if query had at least one multiselect query (queries separated by &#39;or&#39; keyword)</li>
</ul>
<p>input</p>
<ul>
<li>data = query column from line of data</li>
</ul>
<p>output</p>
<p> returns object with keys:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">parseQuery</span></span> = (query) -&gt;
	<span class="keyword">return</span> <span class="keyword">unless</span> query

	matches = []
	has_multiselect = <span class="literal">false</span>
	<span class="keyword">unless</span> _find_subquery query,matches
		<span class="keyword">for</span> q <span class="keyword">in</span> query.split(<span class="regexp">/,/</span>)
			<span class="keyword">if</span> -<span class="number">1</span> <span class="keyword">isnt</span> q.search( qr_or_delimiter)
				submatches = []
				<span class="keyword">for</span> submatch <span class="keyword">in</span> q.split(qr_or_delimiter)
					_find_subquery submatch, submatches
				<span class="keyword">if</span> submatches.length &gt; <span class="number">0</span>
					has_multiselect = <span class="literal">true</span> <span class="keyword">unless</span> has_multiselect
					matches.push submatches
			<span class="keyword">else</span>
				_find_subquery q, matches

	<span class="keyword">return</span> { query, matches, has_multiselect }</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <h2>_find_subquery(query,matches)</h2>

            </div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Uses <code>qr_subj_verb</code> and <code>qr_subj_verb_obj</code> regexes defined at top and tries to 
match whole text, <code>query</code>, with the regexes.  </p>
<p>input</p>
<ul>
<li>data = query column from line of data</li>
<li>matches = Array to store matches found </li>
</ul>
<p>output</p>
<p> returns Boolean, whether or not a match was found</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">_find_subquery</span></span> = (query,matches) -&gt;
	subquery_matches = []</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap for-h5">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <h5>It&#39;s a subject verb match</h5>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="keyword">if</span> -<span class="number">1</span> <span class="keyword">isnt</span> query.search qr_subj_verb
		subquery_matches = query.match qr_subj_verb
		matches.push(subquery_matches.slice(<span class="number">1</span>))
		<span class="keyword">return</span> <span class="literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap for-h5">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <h5>It&#39;s a subject verb object match</h5>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="keyword">else</span> <span class="keyword">if</span> ( 
		(-<span class="number">1</span> <span class="keyword">is</span> query.search qr_or_delimiter ) <span class="keyword">and</span> 
		(subquery_matches = query.match qr_subj_verb_obj)
	)
		matches.push subquery_matches.slice(<span class="number">1</span>)
		<span class="keyword">return</span> <span class="literal">true</span>
	<span class="keyword">return</span> <span class="literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <h2>addResult(data)</h2>

            </div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Iterate over parseQuery <code>matches</code> to aggregate results, adding and incrementing 
data in <code>finial</code> object</p>
<p>input</p>
<ul>
<li>object = return value from <code>parseQuery</code></li>
</ul>
<p>output
return undefined</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">addResult</span></span> = (data) -&gt;
	<span class="keyword">return</span> <span class="keyword">unless</span> data
	query = data.query
	matches = data.matches
	_increment(finial,<span class="string">'has_multiselect'</span>) <span class="keyword">if</span> data.has_multiselect?
	<span class="keyword">for</span> match <span class="keyword">in</span> matches
		<span class="keyword">if</span> <span class="keyword">typeof</span> match <span class="keyword">is</span> <span class="string">'string'</span>
			<span class="keyword">continue</span>
		<span class="keyword">if</span> Object::toString.call(match[<span class="number">0</span>]) <span class="keyword">isnt</span> <span class="string">'[object Array]'</span>
			_count_query match
			<span class="keyword">continue</span>
		subj_seen = {}
		verb_seen = {}
		obj_seen = {}
		_count_query submatch,subj_seen,verb_seen,obj_seen <span class="keyword">for</span> submatch <span class="keyword">in</span> match
	<span class="keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <h2>_increment(data,k)</h2>

            </div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Increment the value at <code>data[k]</code> if k exists, else, adding k to data with initial value of 1</p>
<p>input</p>
<ul>
<li>data = object to test for existence of k</li>
<li>k = String</li>
</ul>
<p>output
returns undefined</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">_increment</span></span> = (data,k) -&gt;
	<span class="keyword">if</span> k <span class="keyword">not</span> <span class="keyword">of</span> data
		data[k] = <span class="number">1</span>
	<span class="keyword">else</span>
		data[k]++
	<span class="keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <h2>_count_query(q,subj_seen,verb_seen,obj_seen)</h2>

            </div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Increment subjects, verbs, and objects found in a query.<br>Only increment a subject, verb or object once if in multiple times from a multiselect query</p>
<p>input</p>
<ul>
<li>q = Array of query words.  Can be:</li>
<li>Subject, Verb</li>
<li>Subject, Verb, Object</li>
<li>subj_seen Object</li>
<li>verb_seen Object</li>
<li>obj_seen Objects containing Subjects, Verbs, Objects seen so far when iterating a multiselect query</li>
</ul>
<p>output
returns undefined </p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">_count_query</span></span> = (q,subj_seen,verb_seen,obj_seen) -&gt;
	<span class="keyword">return</span> <span class="keyword">unless</span> q
	[subj,verb,obj] = q <span class="keyword">if</span> q
	<span class="keyword">return</span> <span class="keyword">unless</span> subj <span class="keyword">and</span> verb
	<span class="keyword">if</span> subj_seen <span class="keyword">and</span> verb_seen <span class="keyword">and</span> obj_seen
		<span class="keyword">unless</span> subj <span class="keyword">of</span> subj_seen
			subj_seen[subj] = <span class="number">1</span>
			_increment finial,<span class="string">"subject\t<span class="subst">#{subj}</span>"</span>
			_increment finial,<span class="string">"multiselect_subject\t<span class="subst">#{subj}</span>"</span>

		<span class="keyword">unless</span> verb <span class="keyword">of</span> verb_seen
			verb_seen[verb] = <span class="number">1</span>
			_increment finial,<span class="string">"verb\t<span class="subst">#{verb}</span>"</span>
			_increment finial,<span class="string">"multiselect_verb\t<span class="subst">#{verb}</span>"</span>

		<span class="keyword">if</span> obj <span class="keyword">and</span> obj <span class="keyword">not</span> <span class="keyword">of</span> obj_seen
			obj_seen[obj] = <span class="number">1</span>
			_increment finial,<span class="string">"object\t<span class="subst">#{obj}</span>"</span>
			_increment finial,<span class="string">"multiselect_object\t<span class="subst">#{obj}</span>"</span>
	<span class="keyword">else</span>
		_increment finial,<span class="string">"subject\t<span class="subst">#{subj}</span>"</span>
		_increment finial,<span class="string">"verb\t<span class="subst">#{verb}</span>"</span>
		_increment(finial,<span class="string">"object\t<span class="subst">#{obj}</span>"</span>) <span class="keyword">if</span> obj</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <h2>_report(obj,opt_fh)</h2>

            </div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Write a .results file with data from <code>obj</code> sorted descending by <code>obj</code> values</p>
<p>input</p>
<ul>
<li>obj = results object to iterate over</li>
<li>opt_fh = optional open file handle to write data, else write to stdout</li>
</ul>
<p>output
returns undefined</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">report</span></span> = (res,opt_fh) -&gt;
	kys = (k <span class="keyword">for</span> k <span class="keyword">of</span> res)
	kys.sort((a,b) -&gt; <span class="keyword">return</span> res[b] - res[a] )
	<span class="keyword">if</span> opt_fh
		<span class="keyword">for</span> k <span class="keyword">in</span> kys
			opt_fh.write <span class="string">"<span class="subst">#{k}</span>\t<span class="subst">#{res[k]}</span>\n"</span>
	<span class="keyword">else</span>
		<span class="keyword">for</span> k <span class="keyword">in</span> kys
			console.log <span class="string">"<span class="subst">#{k}</span>\t<span class="subst">#{res[k]}</span>\n"</span>
	opt_fh.close() <span class="keyword">if</span> opt_fh</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap for-h1">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <h1>Start of Main</h1>

            </div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <h2>Log queries found</h2>

            </div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Create log files by: </p>
<ul>
<li>joining argv with <code>--</code> </li>
<li>removing any char not in 0-9A-Za-z.,-_</li>
<li>append <code>.queries</code> and <code>.results</code> to the end</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>filenamesjoined = process.argv.join <span class="string">'--'</span>
filenamesjoined = filenamesjoined.replace <span class="regexp">/[^0-9A-Za-z\.\,\-\_]/g</span>,<span class="string">'--'</span>
queries_file = filenamesjoined + <span class="string">'.queries'</span>
results_file = filenamesjoined + <span class="string">'.results'</span>

queries_fh = bwriter.open queries_file
queries_fh.<span class="literal">on</span> <span class="string">'error'</span>, (error) -&gt; console.log <span class="string">"queries error: <span class="subst">#{error}</span>"</span>
results_fh = bwriter.open results_file
results_fh.<span class="literal">on</span> <span class="string">'error'</span>, (error) -&gt; console.log <span class="string">"results error: <span class="subst">#{error}</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Shove all filenames to be parsed into an Object
Delete each filename from Object when file is finished being read.
When object is empty run a report function that outputs the parse results</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>files = {}
(files[file] = <span class="number">1</span> <span class="keyword">for</span> file <span class="keyword">in</span> process.argv[<span class="number">2.</span>.])

<span class="keyword">for</span> file <span class="keyword">of</span> files
	<span class="keyword">do</span> (file) =&gt;
		<span class="keyword">new</span> DataReader(file, encoding: <span class="string">'utf8'</span>)
			.<span class="literal">on</span>(<span class="string">'error'</span>, (error) -&gt; console.log error)
			.<span class="literal">on</span>(<span class="string">'line'</span>, (line, nextByteOffset) -&gt;
				q = getQueryField line
				<span class="keyword">return</span> <span class="keyword">unless</span> q
				logQuery queries_fh,q
				addResult parseQuery q
			)
			.<span class="literal">on</span>(<span class="string">'end'</span>, () -&gt;
				<span class="keyword">delete</span> files[file]
				<span class="keyword">if</span> (key <span class="keyword">for</span> key, value <span class="keyword">of</span> files).length <span class="keyword">is</span> <span class="number">0</span>
					queries_fh.close()
					report finial,results_fh)
			.read()</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
