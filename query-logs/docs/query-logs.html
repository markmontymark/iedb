<!DOCTYPE html>

<html>
<head>
  <title>query-logs.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>query-logs.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="comment">#!/usr/bin/env coffee</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h2>Prerequisities</h2>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>fs = require <span class="string">'fs'</span>
bwriter = require <span class="string">'buffered-writer'</span>
breader = require <span class="string">'buffered-reader'</span>
BinaryReader = breader.BinaryReader
DataReader = breader.DataReader</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Helper function for binaryRead</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">close</span></span> = (binaryReader, error) -&gt;
	console.log error <span class="keyword">if</span> error
	binaryReader.close (error) -&gt;
		console.log error <span class="keyword">if</span> error

offset = <span class="number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Regexes used to split of a query</p>
<p>Queries can be one of 
&#39;Subject Verb&#39;
&#39;Subject Verb Object&#39; 
Queries can be separated by either a comma (which means mulitple queries) or the word, &#39;or&#39; (which means a &#39;multi-select&#39; query)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>qr_subj_verb = <span class="regexp">/^\s*([^,]+)\s+(is\s+excluded)\s*$/</span>
qr_subj_verb_obj = <span class="regexp">/^\s*([^,]+)\s+(equals|contains|is|blast)\s+([^,]+)\s*$/</span>
qr_or_delimiter = <span class="regexp">/\s+or\s+/</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>finial is a object that holds the parsing results
keys of the results are in the format:
subject \t count
verb \t count
object \t count
has_multiselect \t count
multiselect_subject \t count
multiselect_verb \t count
multiselect_object \t count</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>finial = {}

queries_file = process.argv.join <span class="string">'--'</span>
queries_file = queries_file.replace <span class="regexp">/[^0-9A-Za-z\.\,\-\_]/g</span>,<span class="string">'--'</span>

<span class="function"><span class="title">getQueryField</span></span> = (data) -&gt;
	<span class="keyword">return</span> <span class="keyword">unless</span> data
	<span class="keyword">return</span> <span class="keyword">if</span> data.indexOf(<span class="string">'#'</span>) <span class="keyword">is</span> <span class="number">0</span>
	[f0,f1,f2,f3,f4,f5,f6...] = data.split <span class="regexp">/[|]/</span>
	query = f6.join <span class="string">''</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap for-h1">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <h1>deal with query having | chars in it, ie entire field isn&#39;t quoted if it contains the delimiter character</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>	yes_no_idx = <span class="number">0</span>
	<span class="keyword">for</span> f <span class="keyword">in</span> f6
		<span class="keyword">break</span> <span class="keyword">if</span> <span class="regexp">/^\s*(?:yes|no)\s*$/</span>.test f
		yes_no_idx++

	query = (f6[i] <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0.</span>.(yes_no_idx-<span class="number">2</span>)]).join <span class="string">'|'</span> <span class="keyword">unless</span> yes_no_idx <span class="keyword">is</span> <span class="number">0</span>
	<span class="keyword">return</span> <span class="keyword">if</span> <span class="regexp">/^\s*$/</span>.test query
	query = query.replace <span class="regexp">/^\s+/</span>,<span class="string">''</span>
	query.replace <span class="regexp">/\s+$/</span>,<span class="string">''</span>


<span class="function"><span class="title">logQuery</span></span> = (fh,data) -&gt;
	<span class="keyword">return</span> <span class="keyword">unless</span> data
	fh.write data
	fh.write <span class="string">"\n"</span> <span class="keyword">unless</span> <span class="regexp">/\n$/</span>.test data

 
<span class="function"><span class="title">parseQuery</span></span> = (query) -&gt;
	<span class="keyword">return</span> <span class="keyword">unless</span> query

	matches = []
	has_multiselect = <span class="number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>console.log &quot;parseQuery: #{query}&quot;</p>
<h1>getting complex, we have multi-select queries, so that&#39;s multiple [subject|verb|[object]]+ separated by , or &#39;or&#39;</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="keyword">unless</span> _find_subquery query,matches</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>split on &#39;,&#39; first, &#39;or&#39; second and see if any subqueries fail a  subj|verb|(obj)* match</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="keyword">for</span> q <span class="keyword">in</span> query.split(<span class="regexp">/,/</span>)
			<span class="keyword">if</span> -<span class="number">1</span> <span class="keyword">isnt</span> q.search( qr_or_delimiter)
				submatches = []
				<span class="keyword">for</span> submatch <span class="keyword">in</span> q.split(qr_or_delimiter)
					_find_subquery submatch, submatches
				<span class="keyword">if</span> submatches.length &gt; <span class="number">0</span>
					has_multiselect = <span class="number">1</span> <span class="keyword">unless</span> has_multiselect
					matches.push submatches
			<span class="keyword">else</span>
				_find_subquery q, matches

	<span class="keyword">return</span> { query, matches, has_multiselect }



<span class="function"><span class="title">_find_subquery</span></span> = (query,matches) -&gt;
	subquery_matches = []</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap for-h1">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <h1>simple match, subject verb</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="keyword">if</span> -<span class="number">1</span> <span class="keyword">isnt</span> query.search qr_subj_verb
		subquery_matches = query.match qr_subj_verb
		matches.push(subquery_matches.slice(<span class="number">1</span>))</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>console.log &quot;\t\tsubj verb match: #{subquery_matches} == subquery_matches.length = #{subquery_matches.length}&quot;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="keyword">return</span> <span class="number">1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap for-h1">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <h1>simple match, subject verb object</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="keyword">else</span> <span class="keyword">if</span> (-<span class="number">1</span> <span class="keyword">is</span> query.search qr_or_delimiter) <span class="keyword">and</span> (subquery_matches = query.match qr_subj_verb_obj)
		matches.push subquery_matches.slice(<span class="number">1</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>console.log &quot;\t\tsubj verb obj match: #{subquery_matches.slice(1)}&quot;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="keyword">return</span> <span class="number">1</span>
	<span class="keyword">return</span> <span class="number">0</span>

 
<span class="function"><span class="title">addResult</span></span> = (data)-&gt;
	<span class="keyword">return</span> <span class="keyword">unless</span> data
	query = data.query
	matches = data.matches</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>console.log &quot;addResults #{query}&quot;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	_increment(finial,<span class="string">'has_multiselect'</span>) <span class="keyword">if</span> data.has_multiselect? &gt; <span class="number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>console.log &quot;has multiselect? &quot;, (exists data-&gt;{has_multiselect} and data-&gt;{has_multiselect} ? &#39;y&#39; : &#39;n&#39;) ,&quot;\n&quot;;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="keyword">for</span> match <span class="keyword">in</span> matches</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>console.log &quot;match #{match}&quot;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="keyword">if</span> <span class="keyword">typeof</span> match <span class="keyword">is</span> <span class="string">'string'</span>
			<span class="keyword">continue</span>
		<span class="keyword">if</span> Object::toString.call(match[<span class="number">0</span>]) <span class="keyword">isnt</span> <span class="string">'[object Array]'</span>
			_count_query match
			<span class="keyword">continue</span>
		subj_seen = {}
		verb_seen = {}
		obj_seen = {}
		_count_query submatch,subj_seen,verb_seen,obj_seen <span class="keyword">for</span> submatch <span class="keyword">in</span> match
	<span class="keyword">return</span>


<span class="function"><span class="title">_increment</span></span> = (data,k) -&gt;
	<span class="keyword">if</span> k <span class="keyword">not</span> <span class="keyword">of</span> data
		data[k] = <span class="number">1</span>
	<span class="keyword">else</span>
		data[k]++
	<span class="keyword">return</span>

<span class="function"><span class="title">_count_query</span></span> = (q,subj_seen,verb_seen,obj_seen) -&gt;
	<span class="keyword">return</span> <span class="keyword">unless</span> q
	[subj,verb,obj] = q <span class="keyword">if</span> q
	<span class="keyword">return</span> <span class="keyword">unless</span> subj <span class="keyword">and</span> verb</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>console.log &quot;subj #{subj} verb #{verb} obj #{obj ? &#39;undef&#39;}&quot;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="keyword">if</span> subj_seen <span class="keyword">and</span> verb_seen <span class="keyword">and</span> obj_seen
		<span class="keyword">unless</span> subj <span class="keyword">of</span> subj_seen
			subj_seen[subj] = <span class="number">1</span>
			_increment finial,<span class="string">"subject\t<span class="subst">#{subj}</span>"</span>
			_increment finial,<span class="string">"multiselect_subject\t<span class="subst">#{subj}</span>"</span>

		<span class="keyword">unless</span> verb <span class="keyword">of</span> verb_seen
			verb_seen[verb] = <span class="number">1</span>
			_increment finial,<span class="string">"verb\t<span class="subst">#{verb}</span>"</span>
			_increment finial,<span class="string">"multiselect_verb\t<span class="subst">#{verb}</span>"</span>

		<span class="keyword">if</span> obj <span class="keyword">and</span> obj <span class="keyword">not</span> <span class="keyword">of</span> obj_seen
			obj_seen[obj] = <span class="number">1</span>
			_increment finial,<span class="string">"object\t<span class="subst">#{obj}</span>"</span>
			_increment finial,<span class="string">"multiselect_object\t<span class="subst">#{obj}</span>"</span>
	<span class="keyword">else</span>
		_increment finial,<span class="string">"subject\t<span class="subst">#{subj}</span>"</span>
		_increment finial,<span class="string">"verb\t<span class="subst">#{verb}</span>"</span>
		_increment(finial,<span class="string">"object\t<span class="subst">#{obj}</span>"</span>) <span class="keyword">if</span> obj



<span class="function"><span class="title">report</span></span> = (res,opt_fh) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>console.log &quot;in report&quot;
console.log &quot;report key length #{(key for key, value of res).length}&quot;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	kys = (k <span class="keyword">for</span> k <span class="keyword">of</span> res)
	kys.sort((a,b) -&gt; <span class="keyword">return</span> res[b] - res[a] )</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>console.log &quot;kys #{kys}&quot;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="keyword">if</span> opt_fh
		<span class="keyword">for</span> k <span class="keyword">in</span> kys</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>console.log &quot;1 kys #{k}\t#{res[k]}\n&quot;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			opt_fh.write <span class="string">"<span class="subst">#{k}</span>\t<span class="subst">#{res[k]}</span>\n"</span>
	<span class="keyword">else</span>
		<span class="keyword">for</span> k <span class="keyword">in</span> kys</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>console.log &quot;2 kys #{k}\t#{res[k]}\n&quot;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			console.log <span class="string">"<span class="subst">#{k}</span>\t<span class="subst">#{res[k]}</span>\n"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>console.log &quot;leaving report&quot;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	opt_fh.close() <span class="keyword">if</span> opt_fh</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap for-h1">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <h1>open my queries_fh, &quot;&gt;queries_file.queries&quot; or die &quot;Can&#39;t create queries_file.queries, !\n&quot;</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>queries_fh = bwriter.open <span class="string">'queries'</span>
queries_fh.<span class="literal">on</span> <span class="string">'error'</span>, (error) -&gt; console.log <span class="string">"queries error: <span class="subst">#{error}</span>"</span>
results_fh = bwriter.open <span class="string">'results'</span>
results_fh.<span class="literal">on</span> <span class="string">'error'</span>, (error) -&gt; console.log <span class="string">"results error: <span class="subst">#{error}</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Shove all filenames to be parsed into an Object
Will delete each filename from Object and when Object is empty
will run a report function that outputs the parse results</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>files = {}
(files[file] = <span class="number">1</span> <span class="keyword">for</span> file <span class="keyword">in</span> process.argv[<span class="number">2.</span>.])

<span class="keyword">for</span> file <span class="keyword">of</span> files
	<span class="keyword">do</span> (file) =&gt;
		<span class="keyword">new</span> DataReader(file, encoding: <span class="string">'utf8'</span>)
			.<span class="literal">on</span>(<span class="string">'error'</span>, (error) -&gt; console.log error)
			.<span class="literal">on</span>(<span class="string">'line'</span>, (line, nextByteOffset) -&gt;
				q = getQueryField line
				<span class="keyword">return</span> <span class="keyword">unless</span> q
				logQuery queries_fh,q
				addResult parseQuery q
			)
			.<span class="literal">on</span>(<span class="string">'end'</span>, () -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>at the end of each parsed file, remove that filename from the files Object
so that when Object has no keys, run the function, report, that writes out
the combined results to a file called &#39;results&#39;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="keyword">delete</span> files[file]
				<span class="keyword">if</span> (key <span class="keyword">for</span> key, value <span class="keyword">of</span> files).length <span class="keyword">is</span> <span class="number">0</span>
					queries_fh.close()
					report finial,results_fh</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>return unless offset
new BinaryReader(file).seek offset,(error) -&gt;
return close(@, error) if error)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			.read()</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
